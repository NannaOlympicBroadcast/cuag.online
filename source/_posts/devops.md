---
title: devops背诵手册
date: 2025-01-10 13:24:15
tags:
  - DevOps
  - 运维
  - 云计算
  - 科教兴国
  - 创业
  - PaaS
  - Docker
  - 虚拟化
  - 期末考试
  - Git
  - CI/CD
---
# 什么是
- Dev：Develop（开发）
- Ops：Operation（运维）
- 有什么作用：打破开发、测试、运维、壁垒；自动化；降本增效
# 专题1：运维与Devops方法论
## 背景助理解
### 项目名称
御姐加油站
#### 功能
0. 用户的登录和注册：用户使用微信扫码关注公众号登录，并且通过微信或者支付宝充值39.9元可以升级为会员。
1. 上传御姐资料：上传每个网红或者身边的美女的照片、个人经历、获得成就、专辑名或者参演的影视剧类节目名称。
2. 发帖跟踪御姐的事件：会员用户能够将每位御姐的事件进行发帖，登录用户能够进行点赞评论、并能回复、点踩举报评论和帖子。
3. 模拟和御姐聊天：通过后端接入大模型，根据帖子、资料持续学习御姐的个人事迹来模拟御姐的人设、并且可以和御姐语音通话，普通用户可以每天20句对话和10min的语音通话，会员每天对话数量无限，并且可以打3小时的语音通话
4. 管理用户：管理员通过管理后台注册，可以审核举报内容，并且能够选择将相关用户封禁
#### 体系架构
- 后端：基于微服务的架构：公司有三台腾讯云的服务器（每个6CPU32G内存），使用docker swarm管理由Go语言、Java、Python写的几个微服务镜像，并使用API网关统一对外服务（有公网ip，但不考虑CDN加速），现在公司还没有讨论怎么划分微服务
- 云数据库：使用腾讯云的MySQL、Mongo和Redis作为后端的数据库（假设容量足够）
- 对象储存：使用腾讯云COS服务（假设容量足够）
- AI服务：假设大语言模型对话服务、RAG服务、语音转文字、语音合成服务都由另外一家公司B提供，B公司也提供了工作流定制的服务，即调用B公司的上传API，就可以将文件传输到对应客户工作空间的知识库里面，这样便可以在调用B公司的大语言模型聊天服务的同时先进行知识检索，并结合提示词一起回答，语音通话则是用户在前端打开一个webrtc通道连接到B公司的服务器，上面的服务器先将用户传输过来的音频流转化为文字，然后送入前面提到的AI chat completion服务，如果大语言模型生成一个chunck，则将其送入语音合成服务，再将合成的音频片段顺着原来的webrtc的通道传输，调用语音通话API只需要通过HTTP接口指定后端大语言模型，并获得一个加签，前端通过携带加签，则可以和B公司的语音通话服务进行信令传输并打开RTC通道
- 管理后台服务：部署在公司**内网**集群中，并且通过公司内部的oauth2.0决定操作权限，仅限公司内网访问
- 监控服务：使用gafrana大屏进行监控，部署在公司内网集群中，但是通过路由可以外网访问
- 持续集成：代码托管和流水线运行在腾讯云coding的平台上，而构建节点采用公司内网的虚拟机
- 前端服务：前端用vuejs写，托管在github上，提交master分支的仓库则触发关联的cloudflare pages自动构建，并部署在cloudflare pages服务商
#### 开发方式
- 前端代码托管在github上，如果提交master分支，就触发其部署到cloudflare pages上面，如果提交dev分支，则只触发代码质量检查
- 后端代码托管在腾讯云coding上，每个微服务分为一个仓库，提交仓库，则触发单元测试和集成测试，然后构建对应的docker镜像，如果是dev分支，则其会触发其后续部署在公司内网的模拟测试环境（使用内网数据库和minio作为对象存储服务），如果是master分支，则会先将其推送到公有云docker仓库上，并且通过ssh命令暂停正式发布服务器的对应微服务重新拉取并更新再重启服务。
- 团队使用钉钉进行远程会议、消息交流，并且流水线触发、代码提交情况会被发送到对应的群里面
#### 进一步计划
- 响应国家「西数东算」政策的号召，公司在甘肃兰州建立了一个机房，其总共服务器能够提供512核心和10T内存以及100张4090的GPU算力、并且拥有三个独立的公网ipv4，公司于是想着把服务迁移到k8s上，并且对于AI运算和推理的服务，已经通过和B公司商量好，由B公司的私有云平台提供Webrtc传输、GPU算力调度、大模型推理的服务，到时候以一个机房局域网微服务API的形式给出（格式和B公司公有云服务一样）
## 摩尔定律和反摩尔定律
- 价格不变、18-24个月、性能一翻
- 卖掉相同、18月、营业额一半
## 历史沿革
- 软件的架构几个阶段：单体架构、分层架构、SOA、微服务架构、Service Mesh架构
- 2009：Patrick、类比敏捷开发、提出Devops、第一届Devops大会
- 2013：《凤凰项目》（什么是「凤凰商城」、遇到了什么问题、如何解决、启示是什么？）
- 2018：中国Devops社区
- 2023：**南京大学**主导的Devops国标
## 3 Ways
### System Thinking：熟悉流水线、提高流水线流量、为了目标实现工作流优化
- 怎么做：构建、集成、交付；限制半成品（半成品商榷后再发布）；看板
### Amplify Feedback Loop：加强用户的反馈、从源头保证质量、避免问题再发生
- 怎么做：适当停止生产线、构建自动化测试套件、Dev和Ops共享target和pain、远程监视
### Culture Of Experimental and Learning：培育「试错文化」
- 怎么做：20%非功能；鼓励强化改进；营造~的企业文化氛围
## 4种项目
1. 业务项目：主要的、公司项目管理办公室管理
2. 内部项目：改进的运维基础架构、运维项目内部改进项目、不集中跟踪管理、瓶近期投入不易估量
```
e.g. 为了能够更好的管理迁移到甘肃的服务，IT团队开发出了四种云原生运维套件：S***a集群管理工具、Sasablue算力调度和推理引擎、M******e消息队列、L***a服务发现，并像Kafka、Etcd一样开源成为下一代的云原生基础设施
```
3. 变更：由1和2衍生出来的，问题跟踪管理、多套系统管理（一个问题影响到另外一个问题）
4. 计划外：故障处理
## 精益生产和devops：传统精益和devops同原理
### 精益（精益求精）理论
- 降低批量规模：对于「御姐加油站」每个功能的子功能划分多个版本逐步上线，便于发现问题
- 减少半成品（对应Devops三种方法的第一种「控制半成品给数量」）：语音聊天功能完善了再上线而不是一下子就上线
- 缩短并增强反馈回路（对应Devops三方法的第二种）：聊天的时候设置直接在生成内容下面设置「点踩按钮」
## 敏捷开发与devops：借鉴敏捷宣言
### 敏捷宣言
- 个体和互动大于流程和工具：开发过程中面对面交流大于飞书钉钉看板
- 工作的系统大于详尽的文档：演示功能使用大于写一大堆文档让你读
- 程序员和用户的合作大于合同谈判：「加油站」会员价格和政策更多倾向于用户的感受而非用户合同
- 响应变化大于遵循计划：响应「东数西算」政策，程序员不得不改变原来docker swarm的架构，迁移到甘肃机房的k8s上
## Devops的工具（以e.coding.net为例）
- 源代码管理：代码托管
- 构建服务器：coding的持续集成可以选择使用构建集群或者自己接入节点
- 基础设施、环境配置管理：coding支持接入裸机、k8s、serverless、cos等
- 虚拟基础架构和容器：docker作为容器引擎，由腾讯云的服务器或者自接入节点提供虚拟化的基础架构
- 测试自动化：使用ifbook可以实现api和自动化测试管理
- 管道编排：可以定制自动化工作流
## 关键术语
### CI/CD
- 持续集成：开发者持续的将代码集中提交到一个中央仓库里面，并且每次提交都触发自动构建和测试，以早发现问题
- 持续交付：快速的、少浪费的将代码部署到生产环境，便于用户和开发者建立更强的反馈（对应devops三方法第二点、精益理论第三点「缩短并加强反馈回路」）
- 持续部署：快速的部署并将变化立即能够让用户看到（cf-pages在提交前端代码以后立刻可以部署到全球网络让使用者看到前端页面变化）
### 四大指标
部署频率、变更进入生产时间（t0部署-t0提交）、平均恢复时间（MTTR=AVG(t0恢复-t0-部署)）、改变失败率
### A/B 测试
变更后和变更前的测试
## Scrum
### 三个角色（不要合并Owner和Scrum Master）
- Product Owner：唯一有权要求做事、改变列表优先级；最大化产品和团队的价值
- Scrum Master：确保Scrum被理解和实施、充当教练
- Team：开发团队
- Out Of the Team：把有兴趣关心，并无利益或价值牵扯的人（其他部门、高管、「御姐」群体），排除在项目决策团队以外！
### 用户故事
#### 为什么
- 完美文档的缺陷：低共识
- Story和task

Story是用户需求，可以共享，每个人的Task为了完成Story中提出的需求，Task是具体开发任务，不共享，每个人完成各自的（用户能够和御姐聊天是Story，而将知识库接入LLM以更好的模仿御姐的个性属于Task）
#### 用户故事的模板
```text
作为xx用户
我想xxx
以达到xxxx的价值
```
e.g.作为管理员，我想查看被举报的内容及其创作者，并能够决定是否封禁其账号，来维护这个网络社区的氛围
#### 3C原则
Card（占位符）、Conversation（为了达成共识、实时交谈）、Communication（接受标准：我们知道他何时完工）
#### 产品Backlog：Scrum的核心
用户故事重要性列表排序
### Scrum的工作流程以及要素
1. Scrum会议
- 目标：以终为始
2. 估算
- 单位：Story Point；SML（T恤尺码）
- 差异原因：对于需求的理解、对于技术的熟练度
3. 白板

要素：Not Checked Out、Checked Out、SprintGoal、Unplanned Items、Next
4. 燃尽图
- 需要完成、还剩多少、现在速率是否能达到
5. 每日站会
- 移动看板的任务、更新燃尽图
6. Sprint演示
- Sprint结束于演示
7. Sprint回顾会议
## 看板开发核心要点
1. 可视化工作流程，Kanban方法：提高信息辐射的作用，容易发现团队工作的状态和问题、降低沟通交流成本
2. 限制在制品（WIP上限，超上线阻塞）：减少在制品使其快速流过整个工作流，使前置时间缩短（对应3方法中的第一点「提高流水线流量和流通效率」、与Devops指标中降低「变更进入生产时间」类似）
# 专题2：云原生时代的基于微服务的新型DevOps
## 背景助记
为了响应「乡村振兴」的号召，asynchronous公司与腾讯、字节、大疆联合推出了一款「无人机云乡村」服务。
### 客户和需求
1. 乡村企业或者政府委会等：订购服务然后asynchronous公司能够将一个具有8*4090、512G RAM、256Core算力的中控AI服务器（边缘盒子）以及配套的无线电控制递送到乡村，并且由无线电装置由边缘盒子操控无人机进行作业，中控AI服务器在安装asynchronous的服务以后，就连接到asynchronous的云服务，借此可以从服务市场中拉取以docker-compose为组织的一组微服务应用如无人机农业、无人机云游等服务，连接上asynchronous的服务的边缘盒子也可以将无人机画面进行抖音或者微信视频号直播，也可以通过asynchronous的服务（底层为腾讯云的实时音视频、物联网）开启网页端异地操控，也可以将无人机的画面和控制权转移到线下体验店，让用户通过VR操控无人机，无人机将自身多模态数据由无线电传输到边缘盒子，边缘盒子进行处理调度无人机的任务，当然无人机内嵌基础小模型来操控其基础的避障、移动功能
2. 客户可以通过微信视频号和抖音观看无人机直播，客户也可以在线下体验店操控无人机进行无人机云游。
3. 服务开发者：asynchronous公司为服务市场开发者提供开发平台，实现持续集成、持续构建，使用腾讯云部署的NVIDIA Issac Sim模拟测试，然后进行发布
### 故事场景
山西省有一个山村处于深山之中，当地村委会为了更好的保障村民的安全，则决定引进系统派遣无人机定期巡查村庄，通过多模态数据来检测村庄基础设施的安全隐患并适当记录村民及外来人员的行动行为，村庄管理者可以通过web和安卓或者ios app实时查看无人机的画面，并看到大模型发现的隐患问题描述

一家位于北京的初创公司收到了上述村庄的需求，并与「无人机乡村云」平台的应用市场沟通，成为签约开发者，为山西的村庄开发一个「无人机应用」，其在开发的过程中，完全使用了asynchronous公司为服务市场开发者提供的集成代码托管、持续集成、制品仓库、持续测试、持续交付等为一体的开发者平台
## 云雾计算 XaaS
1. 云雾计算
- 云计算（腾讯云和字节的服务）：数据能力强、高延时、用户隐私难以保护、高能耗
- 边缘计算（无人机的本地模型）：与云计算相反
- 雾计算（边缘盒子）：解决边缘计算数据抽象、命名规则、异构问题
2. XaaS
- PaaS和SaaS的区别：PaaS数据和应用层由企业自己管理，反之由平台托管
## IT服务五标准
1. CMMI-SVC
